<!doctype html><!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]--><!--[if gt IE 8]><!-->
<html class="no-js" lang="en"> <!--<![endif]--> 
 <head> 
  <meta charset="utf-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>Queue example - a concurrent web spider — Tornado 6.1 documentation</title> 
  <link rel="shortcut icon" href="../_static/favicon.ico"> 
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script> 
  <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script> 
  <script type="text/javascript" src="../_static/jquery.js"></script> 
  <script type="text/javascript" src="../_static/underscore.js"></script> 
  <script type="text/javascript" src="../_static/doctools.js"></script> 
  <script type="text/javascript" src="../_static/language_data.js"></script> 
  <script async type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-doc-embed.js"></script> 
  <script type="text/javascript" src="../_static/js/theme.js"></script> 
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css"> 
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css"> 
  <link rel="index" title="Index" href="../genindex.html"> 
  <link rel="search" title="Search" href="../search.html"> 
  <link rel="next" title="Structure of a Tornado web application" href="structure.html"> 
  <link rel="prev" title="Coroutines" href="coroutines.html"> <!-- RTD Extra Head --> <!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
--> 
  <link rel="canonical" href="https://www.tornadoweb.org/en/stable/guide/queues.html"> 
  <link rel="stylesheet" href="https://assets.readthedocs.org/static/css/readthedocs-doc-embed.css" type="text/css"> 
  <script type="application/json" id="READTHEDOCS_DATA">{"ad_free": true, "api_host": "https://readthedocs.org", "build_date": "2020-10-31T00:02:56Z", "builder": "sphinx", "canonical_url": "https://www.tornadoweb.org/en/stable/", "commit": "2047e7ae", "docroot": "/docs/", "features": {"docsearch_disabled": false}, "global_analytics_code": "UA-17997319-1", "language": "en", "page": "guide/queues", "programming_language": "py", "project": "tornado", "proxied_api_host": "/_", "source_suffix": ".rst", "subprojects": {}, "theme": "sphinx_rtd_theme", "user_analytics_code": "UA-39143969-1", "version": "stable"}</script> <!--
Using this variable directly instead of using `JSON.parse` is deprecated.
The READTHEDOCS_DATA global variable will be removed in the future.
--> 
  <script type="text/javascript">
READTHEDOCS_DATA = JSON.parse(document.getElementById('READTHEDOCS_DATA').innerHTML);
</script> 
  <script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-analytics.js" async></script> <!-- end RTD <extrahead> --> 
 </head> 
 <body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav"> 
   <nav data-toggle="wy-nav-shift" class="wy-nav-side"> 
    <div class="wy-side-scroll"> 
     <div class="wy-side-nav-search"> <a href="../index.html" class="icon icon-home"> Tornado </a> 
      <div class="version">
        stable 
      </div> 
      <div role="search"> 
       <form id="rtd-search-form" class="wy-form" action="../search.html" method="get"> 
        <input type="text" name="q" placeholder="Search docs"> 
        <input type="hidden" name="check_keywords" value="yes"> 
        <input type="hidden" name="area" value="default"> 
       </form> 
      </div> 
     </div> 
     <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation"> 
      <ul class="current"> 
       <li class="toctree-l1 current"><a class="reference internal" href="../guide.html">User’s guide</a>
        <ul class="current"> 
         <li class="toctree-l2"><a class="reference internal" href="intro.html">Introduction</a></li> 
         <li class="toctree-l2"><a class="reference internal" href="async.html">Asynchronous and non-Blocking I/O</a></li> 
         <li class="toctree-l2"><a class="reference internal" href="coroutines.html">Coroutines</a></li> 
         <li class="toctree-l2 current"><a class="current reference internal" href="#"><code class="docutils literal notranslate"><span class="pre">Queue</span></code> example - a concurrent web spider</a></li> 
         <li class="toctree-l2"><a class="reference internal" href="structure.html">Structure of a Tornado web application</a></li> 
         <li class="toctree-l2"><a class="reference internal" href="templates.html">Templates and UI</a></li> 
         <li class="toctree-l2"><a class="reference internal" href="security.html">Authentication and security</a></li> 
         <li class="toctree-l2"><a class="reference internal" href="running.html">Running and deploying</a></li> 
        </ul> </li> 
       <li class="toctree-l1"><a class="reference internal" href="../webframework.html">Web framework</a></li> 
       <li class="toctree-l1"><a class="reference internal" href="../http.html">HTTP servers and clients</a></li> 
       <li class="toctree-l1"><a class="reference internal" href="../networking.html">Asynchronous networking</a></li> 
       <li class="toctree-l1"><a class="reference internal" href="../coroutine.html">Coroutines and concurrency</a></li> 
       <li class="toctree-l1"><a class="reference internal" href="../integration.html">Integration with other services</a></li> 
       <li class="toctree-l1"><a class="reference internal" href="../utilities.html">Utilities</a></li> 
       <li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions</a></li> 
       <li class="toctree-l1"><a class="reference internal" href="../releases.html">Release notes</a></li> 
      </ul> 
     </div> 
    </div> 
   </nav> 
   <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"> 
    <nav class="wy-nav-top" aria-label="top navigation"> <i data-toggle="wy-nav-top" class="fa fa-bars"></i> <a href="../index.html">Tornado</a> 
    </nav> 
    <div class="wy-nav-content"> 
     <div class="rst-content"> 
      <div role="navigation" aria-label="breadcrumbs navigation"> 
       <ul class="wy-breadcrumbs"> 
        <li><a href="../index.html">Docs</a> »</li> 
        <li><a href="../guide.html">User’s guide</a> »</li> 
        <li><code class="docutils literal notranslate"><span class="pre">Queue</span></code> example - a concurrent web spider</li> 
        <li class="wy-breadcrumbs-aside"> <a href="https://github.com/tornadoweb/tornado/blob/stable/docs/guide/queues.rst" class="fa fa-github"> Edit on GitHub</a> </li> 
       </ul> 
       <hr> 
      </div> 
      <div role="main" class="document" itemscope itemtype="http://schema.org/Article"> 
       <div itemprop="articleBody"> 
        <div class="section" id="queue-example-a-concurrent-web-spider"> 
         <h1><a class="reference internal" href="../queues.html#tornado.queues.Queue" title="tornado.queues.Queue"><code class="xref py py-class docutils literal notranslate"><span class="pre">Queue</span></code></a> example - a concurrent web spider<a class="headerlink" href="#queue-example-a-concurrent-web-spider" title="Permalink to this headline">¶</a></h1> 
         <p>Tornado’s <a class="reference internal" href="../queues.html#module-tornado.queues" title="tornado.queues"><code class="xref py py-obj docutils literal notranslate"><span class="pre">tornado.queues</span></code></a> module implements an asynchronous producer / consumer pattern for coroutines, analogous to the pattern implemented for threads by the Python standard library’s <a class="reference external" href="https://docs.python.org/3.6/library/queue.html#module-queue" title="(in Python v3.6)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">queue</span></code></a> module.</p> 
         <p>A coroutine that yields <a class="reference internal" href="../queues.html#tornado.queues.Queue.get" title="tornado.queues.Queue.get"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Queue.get</span></code></a> pauses until there is an item in the queue. If the queue has a maximum size set, a coroutine that yields <a class="reference internal" href="../queues.html#tornado.queues.Queue.put" title="tornado.queues.Queue.put"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Queue.put</span></code></a> pauses until there is room for another item.</p> 
         <p>A <a class="reference internal" href="../queues.html#tornado.queues.Queue" title="tornado.queues.Queue"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Queue</span></code></a> maintains a count of unfinished tasks, which begins at zero. <a class="reference internal" href="../queues.html#tornado.queues.Queue.put" title="tornado.queues.Queue.put"><code class="xref py py-obj docutils literal notranslate"><span class="pre">put</span></code></a> increments the count; <a class="reference internal" href="../queues.html#tornado.queues.Queue.task_done" title="tornado.queues.Queue.task_done"><code class="xref py py-obj docutils literal notranslate"><span class="pre">task_done</span></code></a> decrements it.</p> 
         <p>In the web-spider example here, the queue begins containing only base_url. When a worker fetches a page it parses the links and puts new ones in the queue, then calls <a class="reference internal" href="../queues.html#tornado.queues.Queue.task_done" title="tornado.queues.Queue.task_done"><code class="xref py py-obj docutils literal notranslate"><span class="pre">task_done</span></code></a> to decrement the counter once. Eventually, a worker fetches a page whose URLs have all been seen before, and there is also no work left in the queue. Thus that worker’s call to <a class="reference internal" href="../queues.html#tornado.queues.Queue.task_done" title="tornado.queues.Queue.task_done"><code class="xref py py-obj docutils literal notranslate"><span class="pre">task_done</span></code></a> decrements the counter to zero. The main coroutine, which is waiting for <a class="reference internal" href="../queues.html#tornado.queues.Queue.join" title="tornado.queues.Queue.join"><code class="xref py py-obj docutils literal notranslate"><span class="pre">join</span></code></a>, is unpaused and finishes.</p> 
         <div class="highlight-default notranslate">
          <div class="highlight">
           <pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>

<span class="kn">from</span> <span class="nn">html.parser</span> <span class="kn">import</span> <span class="n">HTMLParser</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urljoin</span><span class="p">,</span> <span class="n">urldefrag</span>

<span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">gen</span><span class="p">,</span> <span class="n">httpclient</span><span class="p">,</span> <span class="n">ioloop</span><span class="p">,</span> <span class="n">queues</span>

<span class="n">base_url</span> <span class="o">=</span> <span class="s2">"http://www.tornadoweb.org/en/stable/"</span>
<span class="n">concurrency</span> <span class="o">=</span> <span class="mi">10</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">get_links_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="sd">"""Download the page at `url` and parse it for links.</span>

<span class="sd">    Returned links have had the fragment after `#` removed, and have been made</span>
<span class="sd">    absolute so, e.g. the URL 'gen.html#tornado.gen.coroutine' becomes</span>
<span class="sd">    'http://www.tornadoweb.org/en/stable/gen.html'.</span>
<span class="sd">    """</span>
    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span><span class="p">()</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"fetched </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span>

    <span class="n">html</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s2">"ignore"</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">urljoin</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">remove_fragment</span><span class="p">(</span><span class="n">new_url</span><span class="p">))</span> <span class="k">for</span> <span class="n">new_url</span> <span class="ow">in</span> <span class="n">get_links</span><span class="p">(</span><span class="n">html</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">remove_fragment</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">pure_url</span><span class="p">,</span> <span class="n">frag</span> <span class="o">=</span> <span class="n">urldefrag</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pure_url</span>


<span class="k">def</span> <span class="nf">get_links</span><span class="p">(</span><span class="n">html</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">URLSeeker</span><span class="p">(</span><span class="n">HTMLParser</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">HTMLParser</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">urls</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">handle_starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
            <span class="n">href</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"href"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">href</span> <span class="ow">and</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">"a"</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">href</span><span class="p">)</span>

    <span class="n">url_seeker</span> <span class="o">=</span> <span class="n">URLSeeker</span><span class="p">()</span>
    <span class="n">url_seeker</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">url_seeker</span><span class="o">.</span><span class="n">urls</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">queues</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">fetching</span><span class="p">,</span> <span class="n">fetched</span><span class="p">,</span> <span class="n">dead</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">fetch_url</span><span class="p">(</span><span class="n">current_url</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">current_url</span> <span class="ow">in</span> <span class="n">fetching</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">"fetching </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">current_url</span><span class="p">)</span>
        <span class="n">fetching</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">current_url</span><span class="p">)</span>
        <span class="n">urls</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_links_from_url</span><span class="p">(</span><span class="n">current_url</span><span class="p">)</span>
        <span class="n">fetched</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">current_url</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">new_url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
            <span class="c1"># Only follow links beneath the base URL</span>
            <span class="k">if</span> <span class="n">new_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">base_url</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">new_url</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">worker</span><span class="p">():</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">q</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">fetch_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">"Exception: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">url</span><span class="p">))</span>
                <span class="n">dead</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">q</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

    <span class="k">await</span> <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">base_url</span><span class="p">)</span>

    <span class="c1"># Start workers, then wait for the work queue to be empty.</span>
    <span class="n">workers</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">multi</span><span class="p">([</span><span class="n">worker</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">concurrency</span><span class="p">)])</span>
    <span class="k">await</span> <span class="n">q</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">300</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">fetching</span> <span class="o">==</span> <span class="p">(</span><span class="n">fetched</span> <span class="o">|</span> <span class="n">dead</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Done in </span><span class="si">%d</span><span class="s2"> seconds, fetched </span><span class="si">%s</span><span class="s2"> URLs."</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fetched</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Unable to fetch </span><span class="si">%s</span><span class="s2"> URLS."</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">dead</span><span class="p">))</span>

    <span class="c1"># Signal all the workers to exit.</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">concurrency</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">workers</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">io_loop</span> <span class="o">=</span> <span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
    <span class="n">io_loop</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre>
          </div> 
         </div> 
        </div> 
       </div> 
      </div> 
      <footer> 
       <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation"> <a href="structure.html" class="btn btn-neutral float-right" title="Structure of a Tornado web application" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a> <a href="coroutines.html" class="btn btn-neutral float-left" title="Coroutines" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a> 
       </div> 
       <hr> 
       <div role="contentinfo"> 
        <p> © Copyright The Tornado Authors <span class="commit"> Revision <code>2047e7ae</code>. </span> </p> 
       </div> Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 
      </footer> 
     </div> 
    </div> 
   </section> 
  </div> 
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions"> <span class="rst-current-version" data-toggle="rst-current-version"> <span class="fa fa-book"> Read the Docs</span> v: stable <span class="fa fa-caret-down"></span> </span> 
   <div class="rst-other-versions"> 
    <dl> 
     <dt>
      Versions
     </dt> 
     <dd>
      <a href="/en/latest/">latest</a>
     </dd> 
     <dd>
      <a href="/en/stable/">stable</a>
     </dd> 
     <dd>
      <a href="/en/branch6.0/">branch6.0</a>
     </dd> 
     <dd>
      <a href="/en/branch5.1/">branch5.1</a>
     </dd> 
     <dd>
      <a href="/en/branch4.5/">branch4.5</a>
     </dd> 
    </dl> 
    <dl> 
     <dt>
      Downloads
     </dt> 
     <dd>
      <a href="//www.tornadoweb.org/_/downloads/en/stable/pdf/">pdf</a>
     </dd> 
     <dd>
      <a href="//www.tornadoweb.org/_/downloads/en/stable/htmlzip/">html</a>
     </dd> 
     <dd>
      <a href="//www.tornadoweb.org/_/downloads/en/stable/epub/">epub</a>
     </dd> 
    </dl> 
    <dl> 
     <dt>
      On Read the Docs
     </dt> 
     <dd> <a href="//readthedocs.org/projects/tornado/?fromdocs=tornado">Project Home</a> 
     </dd> 
     <dd> <a href="//readthedocs.org/builds/tornado/?fromdocs=tornado">Builds</a> 
     </dd> 
    </dl> 
    <hr> Free document hosting provided by <a href="http://www.readthedocs.org">Read the Docs</a>. 
   </div> 
  </div> 
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  
 </body>
</html>