<!doctype html>
<html class="writer-html5" lang="en"> 
 <head> 
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>Token Scanning — Warehouse  documentation</title> 
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css"> 
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css"> 
  <link rel="canonical" href="https://warehouse.pypa.io/development/token-scanning.html"> <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]--> 
  <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script> 
  <script src="../_static/jquery.js"></script> 
  <script src="../_static/underscore.js"></script> 
  <script src="../_static/doctools.js"></script> 
  <script async src="https://assets.readthedocs.org/static/javascript/readthedocs-doc-embed.js"></script> 
  <script src="../_static/js/theme.js"></script> 
  <link rel="index" title="Index" href="../genindex.html"> 
  <link rel="search" title="Search" href="../search.html"> 
  <link rel="next" title="Warehouse codebase" href="../application.html"> 
  <link rel="prev" title="Malware Checks" href="malware-checks.html"> <!-- RTD Extra Head --> 
  <link rel="stylesheet" href="https://assets.readthedocs.org/static/css/readthedocs-doc-embed.css" type="text/css"> 
  <script type="application/json" id="READTHEDOCS_DATA">{"ad_free": false, "api_host": "https://readthedocs.org", "build_date": "2022-05-16T21:16:41Z", "builder": "sphinx", "canonical_url": null, "commit": "140a2cc3", "docroot": "/docs/", "features": {"docsearch_disabled": false}, "global_analytics_code": "UA-17997319-1", "language": "en", "page": "development/token-scanning", "programming_language": "py", "project": "warehouse", "proxied_api_host": "/_", "source_suffix": ".rst", "subprojects": {}, "theme": "sphinx_rtd_theme", "user_analytics_code": "", "version": "latest"}</script> <!--
Using this variable directly instead of using `JSON.parse` is deprecated.
The READTHEDOCS_DATA global variable will be removed in the future.
--> 
  <script type="text/javascript">
READTHEDOCS_DATA = JSON.parse(document.getElementById('READTHEDOCS_DATA').innerHTML);
</script> 
  <script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-analytics.js" async></script> <!-- end RTD <extrahead> --> 
 </head> 
 <body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav"> 
   <nav data-toggle="wy-nav-shift" class="wy-nav-side"> 
    <div class="wy-side-scroll"> 
     <div class="wy-side-nav-search"> <a href="../index.html" class="icon icon-home"> Warehouse </a> 
      <div class="version">
        latest 
      </div> 
      <div role="search"> 
       <form id="rtd-search-form" class="wy-form" action="../search.html" method="get"> 
        <input type="text" name="q" placeholder="Search docs"> 
        <input type="hidden" name="check_keywords" value="yes"> 
        <input type="hidden" name="area" value="default"> 
       </form> 
      </div> 
     </div>
     <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu"> 
      <ul class="current"> 
       <li class="toctree-l1 current"><a class="reference internal" href="index.html">Development</a>
        <ul class="current"> 
         <li class="toctree-l2"><a class="reference internal" href="getting-started.html">Getting started</a></li> 
         <li class="toctree-l2"><a class="reference internal" href="frontend.html">Frontend</a></li> 
         <li class="toctree-l2"><a class="reference internal" href="patterns.html">Patterns</a></li> 
         <li class="toctree-l2"><a class="reference internal" href="database-migrations.html">Database migrations</a></li> 
         <li class="toctree-l2"><a class="reference internal" href="submitting-patches.html">Submitting patches</a></li> 
         <li class="toctree-l2"><a class="reference internal" href="reviewing-patches.html">Reviewing and merging patches</a></li> 
         <li class="toctree-l2"><a class="reference internal" href="legacy-application-structure.html">Legacy Application URL Structure</a></li> 
         <li class="toctree-l2"><a class="reference internal" href="development-database.html">Updating Development Database</a></li> 
         <li class="toctree-l2"><a class="reference internal" href="cloud.html">Developing in the cloud</a></li> 
         <li class="toctree-l2"><a class="reference internal" href="email.html">Working with E-mails</a></li> 
         <li class="toctree-l2"><a class="reference internal" href="malware-checks.html">Malware Checks</a></li> 
         <li class="toctree-l2 current"><a class="current reference internal" href="#">Token Scanning</a>
          <ul> 
           <li class="toctree-l3"><a class="reference internal" href="#how-to-recognize-a-pypi-secret">How to recognize a PyPI secret</a></li> 
           <li class="toctree-l3"><a class="reference internal" href="#github-secret-scanning">GitHub Secret Scanning</a>
            <ul> 
             <li class="toctree-l4"><a class="reference internal" href="#how-to-test-it-manually">How to test it manually</a></li> 
            </ul> </li> 
           <li class="toctree-l3"><a class="reference internal" href="#gitlab-secret-detection">GitLab Secret Detection</a></li> 
           <li class="toctree-l3"><a class="reference internal" href="#pypi-token-disclosure-infrastructure">PyPI token disclosure infrastructure</a></li> 
          </ul> </li> 
        </ul> </li> 
       <li class="toctree-l1"><a class="reference internal" href="../application.html">Warehouse codebase</a></li> 
       <li class="toctree-l1"><a class="reference internal" href="../api-reference/index.html">API reference</a></li> 
       <li class="toctree-l1"><a class="reference internal" href="../ui-principles.html">UI principles</a></li> 
       <li class="toctree-l1"><a class="reference internal" href="../security.html">Security</a></li> 
       <li class="toctree-l1"><a class="reference internal" href="../translations.html">Translations</a></li> 
       <li class="toctree-l1"><a class="reference internal" href="../roadmap.html">Roadmap and Sprints</a></li> 
      </ul> 
     </div> 
    </div> 
   </nav> 
   <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
    <nav class="wy-nav-top" aria-label="Mobile navigation menu"> <i data-toggle="wy-nav-top" class="fa fa-bars"></i> <a href="../index.html">Warehouse</a> 
    </nav> 
    <div class="wy-nav-content"> 
     <div class="rst-content"> 
      <div role="navigation" aria-label="Page navigation"> 
       <ul class="wy-breadcrumbs"> 
        <li><a href="../index.html" class="icon icon-home"></a> »</li> 
        <li><a href="index.html">Development</a> »</li> 
        <li>Token Scanning</li> 
        <li class="wy-breadcrumbs-aside"> <a href="https://github.com/pypa/warehouse/blob/main/docs/development/token-scanning.rst" class="fa fa-github"> Edit on GitHub</a> </li> 
       </ul> 
       <hr> 
      </div> 
      <div role="main" class="document" itemscope itemtype="http://schema.org/Article"> 
       <div itemprop="articleBody"> 
        <section id="token-scanning"> 
         <h1>Token Scanning<a class="headerlink" href="#token-scanning" title="Permalink to this headline">¶</a></h1> 
         <p>People make mistakes. Sometimes, they post their PyPI tokens publicly. Some content managers run regexes to try and identify published secrets, and ideally have them deactivated. PyPI has started integrating with such systems in order to help secure packages.</p> 
         <div class="contents local topic" id="contents"> 
          <ul class="simple"> 
           <li><p><a class="reference internal" href="#how-to-recognize-a-pypi-secret" id="id2">How to recognize a PyPI secret</a></p></li> 
           <li><p><a class="reference internal" href="#github-secret-scanning" id="id3">GitHub Secret Scanning</a></p> 
            <ul> 
             <li><p><a class="reference internal" href="#how-to-test-it-manually" id="id4">How to test it manually</a></p></li> 
            </ul> </li> 
           <li><p><a class="reference internal" href="#gitlab-secret-detection" id="id5">GitLab Secret Detection</a></p></li> 
           <li><p><a class="reference internal" href="#pypi-token-disclosure-infrastructure" id="id6">PyPI token disclosure infrastructure</a></p></li> 
          </ul> 
         </div> 
         <section id="how-to-recognize-a-pypi-secret"> 
          <h2><a class="toc-backref" href="#id2">How to recognize a PyPI secret</a><a class="headerlink" href="#how-to-recognize-a-pypi-secret" title="Permalink to this headline">¶</a></h2> 
          <p>A PyPI API token is a string consisting of a prefix (<code class="docutils literal notranslate"><span class="pre">pypi</span></code>), a separator (<code class="docutils literal notranslate"><span class="pre">-</span></code>) and a macaroon serialized with PyMacaroonv2, which means it’s the <code class="docutils literal notranslate"><span class="pre">base64</span></code> of:</p> 
          <div class="highlight-default notranslate">
           <div class="highlight">
            <pre><span></span>\<span class="n">x02</span>\<span class="n">x01</span>\<span class="n">x08pypi</span><span class="o">.</span><span class="n">org</span>\<span class="n">x02</span>\<span class="n">x01b</span>
</pre>
           </div> 
          </div> 
          <p>Thanks to this, we know that a PyPI token is bound to start with:</p> 
          <div class="highlight-default notranslate">
           <div class="highlight">
            <pre><span></span><span class="n">pypi</span><span class="o">-</span><span class="n">AgEIcHlwaS5vcmc</span><span class="p">[</span><span class="n">A</span><span class="o">-</span><span class="n">Za</span><span class="o">-</span><span class="n">z0</span><span class="o">-</span><span class="mi">9</span><span class="o">-</span><span class="n">_</span><span class="p">]{</span><span class="mi">70</span><span class="p">,}</span>
</pre>
           </div> 
          </div> 
          <p>A token can be arbitrary long because we may add arbitrary many caveats. For more details on the token format, see <a class="reference external" href="https://pypitoken.readthedocs.io">pypitoken</a>.</p> 
         </section> 
         <section id="github-secret-scanning"> 
          <h2><a class="toc-backref" href="#id3">GitHub Secret Scanning</a><a class="headerlink" href="#github-secret-scanning" title="Permalink to this headline">¶</a></h2> 
          <p>GitHub’s Token scanning feature used to be called “Token Scanning” and is now “Secret Scanning”. You may find the 2 names. GitHub scans public commits with the regex above (actually the limit to at least 130 characters long). For all tokens identified within a “push” event, they send us reports in bulk. The format is explained thouroughly in <a class="reference external" href="https://docs.github.com/en/developers/overview/secret-scanning">their doc</a> as well as in the <a class="reference external" href="https://github.com/pypa/warehouse/issues/6051">warehouse implementation ticket</a>.</p> 
          <p>In short: they send us a cryptographically signed payload describing each leaked token alongside with a public URL pointing to it.</p> 
          <section id="how-to-test-it-manually"> 
           <h3><a class="toc-backref" href="#id4">How to test it manually</a><a class="headerlink" href="#how-to-test-it-manually" title="Permalink to this headline">¶</a></h3> 
           <p>A fake github service is launched by Docker Compose. Head your browser to <code class="docutils literal notranslate"><span class="pre">http://localhost:8964</span></code>. Create/reorder/… one ore more public keys, make sure one key is marked as current, then write your payload, using the following format:</p> 
           <div class="highlight-json notranslate">
            <div class="highlight">
             <pre><span></span><span class="p">[{</span><span class="w"></span>
<span class="w">    </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"pypi_api_token"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">"token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"pypi-..."</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://example.com"</span><span class="w"></span>
<span class="p">}]</span><span class="w"></span>
</pre>
            </div> 
           </div> 
           <p>Send your payload. It sends it to your local Warhouse. If a match is found, you should find that:</p> 
           <ul class="simple"> 
            <li><p>the token you sent has disappeared from the user account page,</p></li> 
            <li><p>2 new security events have been sent: one for the token deletion, one for the notification email.</p></li> 
           </ul> 
           <p>After you send the token, the page will reload, and you’ll find the details of the request at the bottom. If all went well, you should see a <code class="docutils literal notranslate"><span class="pre">204</span></code> (‘No Content’).</p> 
           <p>Whether it worked or not, a bunch of metrics have been issued, you can see them in the <cite>notdatadog</cite> container log.</p> 
          </section> 
         </section> 
         <section id="gitlab-secret-detection"> 
          <h2><a class="toc-backref" href="#id5">GitLab Secret Detection</a><a class="headerlink" href="#gitlab-secret-detection" title="Permalink to this headline">¶</a></h2> 
          <p>GitLab also has an equivalent mechanism, named “Secret Detection”, not implemented in Warehouse yet (see <a class="reference external" href="https://github.com/pypa/warehouse/issues/9280">#9280</a>).</p> 
         </section> 
         <section id="pypi-token-disclosure-infrastructure"> 
          <h2><a class="toc-backref" href="#id6">PyPI token disclosure infrastructure</a><a class="headerlink" href="#pypi-token-disclosure-infrastructure" title="Permalink to this headline">¶</a></h2> 
          <p>The code is mainly in <code class="docutils literal notranslate"><span class="pre">warehouse/integration/github</span></code>. There are 3 main parts in handling a token disclosure report:</p> 
          <ul> 
           <li><p>The Web view, which is the top-level glue but does not implement the logic</p></li> 
           <li><p>Vendor specific authenticity check &amp; loading. In the case of GitHub, we check that the payload and the associated signature match with the public keys available in their meta-API</p></li> 
           <li><p>(Supposedly-)Vendor-independent disclosure analysis:</p> 
            <blockquote> 
             <div>
              <ul class="simple"> 
               <li><p>Each token is processed individually in its own celery task</p></li> 
               <li><p>Token is analyzed, we check if its format is correct and if it corresponds to a macaroon we have in the DB</p></li> 
               <li><p>We don’t check the signature. This is something that could change in the future but for now, we consider that if a token identifier leaked, even without a valid signature, it’s enough to warrant deleting it.</p></li> 
               <li><p>If it’s valid, we delete it, log a security event and send an email (which will spawn a second celery task)</p></li> 
              </ul> 
             </div>
            </blockquote> </li> 
          </ul> 
         </section> 
        </section> 
       </div> 
      </div> 
      <footer>
       <div class="rst-footer-buttons" role="navigation" aria-label="Footer"> <a href="malware-checks.html" class="btn btn-neutral float-left" title="Malware Checks" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a> <a href="../application.html" class="btn btn-neutral float-right" title="Warehouse codebase" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a> 
       </div> 
       <hr> 
       <div role="contentinfo"> 
        <p>© Copyright 2022. <span class="commit">Revision <code>140a2cc3</code>. </span></p> 
       </div> Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 
      </footer> 
     </div> 
    </div> 
   </section> 
  </div> 
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="Versions"> <span class="rst-current-version" data-toggle="rst-current-version"> <span class="fa fa-book"> Read the Docs</span> v: latest <span class="fa fa-caret-down"></span> </span> 
   <div class="rst-other-versions"> 
    <dl> 
     <dt>
      Versions
     </dt> 
     <dd>
      <a href="/en/latest/">latest</a>
     </dd> 
     <dd>
      <a href="/en/stable/">stable</a>
     </dd> 
    </dl> 
    <dl> 
     <dt>
      Downloads
     </dt> 
    </dl> 
    <dl> 
     <dt>
      On Read the Docs
     </dt> 
     <dd> <a href="//readthedocs.org/projects/warehouse/?fromdocs=warehouse">Project Home</a> 
     </dd> 
     <dd> <a href="//readthedocs.org/builds/warehouse/?fromdocs=warehouse">Builds</a> 
     </dd> 
    </dl> 
   </div> 
  </div> 
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  
 </body>
</html>